<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentCore Memory - AgentCore on AWS Demo UI</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            font-weight: 600;
        }
        .code-snippet {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 15px 0;
            overflow-x: auto;
        }
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .result-box.success {
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        .result-box.error {
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }
        .demo-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step-header {
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        {% include 'partials/header.html' %}

        <div class="row main-content">
            <div class="col-12 mt-4">
                <div class="container">
                    <h2 class="text-center mb-4">
                        <i class="fas fa-brain me-2"></i>AgentCore Memory äº¤äº’å¼æ¼”ç¤º
                    </h2>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>AgentCore Memory</strong> æä¾›ä¸¤å¤§æ ¸å¿ƒèƒ½åŠ›ï¼š
                                <strong>Short-term Memory (STM)</strong> - ä¼šè¯å†…çš„çŸ­æœŸè®°å¿†ï¼Œä»¥åŠ
                                <strong>Long-term Memory (LTM)</strong> - è·¨ä¼šè¯çš„é•¿æœŸè®°å¿†ã€‚
                            </div>
                        </div>
                    </div>

                    <!-- Architecture Overview -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="demo-section">
                                <h5 class="step-header">
                                    <i class="fas fa-sitemap me-2"></i>æ¶æ„æ¦‚è§ˆ
                                </h5>
                                <div class="text-center">
                                    <img src="/static/images/memory/agent-memory-arch.png"
                                         class="img-fluid rounded shadow-sm"
                                         alt="AgentCore Memory Architecture"
                                         style="max-width: 100%; height: auto; border: 1px solid #dee2e6;">
                                </div>
                                <p class="text-muted mt-3 text-center">
                                    <small>AgentCore Memory æ•´ä½“æ¶æ„ï¼šå±•ç¤º STM å’Œ LTM å¦‚ä½•ååŒå·¥ä½œ</small>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Memory Management Section -->
                    <div class="demo-section">
                        <h4 class="step-header">
                            <i class="fas fa-cog me-2"></i>æ­¥éª¤ 1: Memory èµ„æºç®¡ç†
                        </h4>

                        <!-- Create Memory -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-plus-circle me-2"></i>åˆ›å»ºæ–°çš„ Memory èµ„æº</h6>
                                <p class="text-muted small">
                                    ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»º STM æˆ– LTM Memory èµ„æºã€‚åˆ›å»ºåè‡ªåŠ¨å¡«å……åˆ°ä¸‹æ–¹çš„è¾“å…¥æ¡†ä¸­ã€‚
                                </p>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" onclick="createSTMMemory()">
                                        <i class="fas fa-clock me-2"></i>åˆ›å»º STM Memory
                                        <span class="spinner-border spinner-border-sm ms-2 loading" id="createSTMLoading"></span>
                                    </button>
                                    <button class="btn btn-info" onclick="createLTMMemory()">
                                        <i class="fas fa-database me-2"></i>åˆ›å»º LTM Memory
                                        <span class="spinner-border spinner-border-sm ms-2 loading" id="createLTMLoading"></span>
                                    </button>
                                    <button class="btn btn-secondary" onclick="listMemories()">
                                        <i class="fas fa-list me-2"></i>åˆ—å‡ºç°æœ‰ Memory
                                        <span class="spinner-border spinner-border-sm ms-2 loading" id="listMemoriesLoading"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Code Display Area -->
                        <div class="row mb-4" id="codeDisplayArea">
                            <div class="col-12">
                                <h6><i class="fas fa-code me-2"></i>åˆ›å»ºä»£ç ç¤ºä¾‹</h6>
                                <div class="code-snippet" id="codeDisplay" style="max-height: 400px; overflow-y: auto;">
                                    <pre id="codeContent" style="margin: 0;">import time
from datetime import datetime
from bedrock_agentcore.memory import MemoryClient

# ========== åˆ›å»º STM (Short-Term Memory) ==========
print("ğŸš€ å¼€å§‹åˆ›å»º Short-Term Memory (STM)")
client = MemoryClient(region_name="us-west-2")

stm = client.create_memory_and_wait(
    name="AgentCore_STM_Demo_xxx",
    strategies=[],  # ç©ºåˆ—è¡¨ = ä¸é…ç½®æå–ç­–ç•¥
    description="Short-term memory demo - ä»…å­˜å‚¨åŸå§‹å¯¹è¯",
    event_expiry_days=7
)
print(f"âœ… STM åˆ›å»ºæˆåŠŸ: {stm['id']}")

# ========== åˆ›å»º LTM (Long-Term Memory) ==========
print("\nğŸš€ å¼€å§‹åˆ›å»º Long-Term Memory (LTM)")

ltm = client.create_memory_and_wait(
    name="AgentCore_LTM_Demo_xxx",
    strategies=[
        {
            "semanticMemoryStrategy": {
                "name": "semantic_facts",
                "description": "æå–ç”¨æˆ·æåˆ°çš„é‡è¦äº‹å®å’Œä¿¡æ¯",
                "namespaces": ["/strategies/{memoryStrategyId}/actors/{actorId}"]
            }
        },
        {
            "userPreferenceMemoryStrategy": {
                "name": "user_preferences",
                "description": "æå–ç”¨æˆ·çš„åå¥½ã€å–œå¥½å’Œä¹ æƒ¯",
                "namespaces": ["/strategies/{memoryStrategyId}/actors/{actorId}"]
            }
        }
    ],
    description="Long-term memory demo - æ™ºèƒ½æå–å’Œè·¨ä¼šè¯è®°å¿†",
    event_expiry_days=30
)
print(f"âœ… LTM åˆ›å»ºæˆåŠŸ: {ltm['id']}")</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Log Output Area -->
                        <div class="row mb-4" id="logOutputArea" style="display: none;">
                            <div class="col-12">
                                <h6><i class="fas fa-terminal me-2"></i>åˆ›å»ºæ—¥å¿—</h6>
                                <div class="code-snippet" id="logDisplay" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace;">
                                    <pre id="logContent" style="margin: 0; color: #d4d4d4;"></pre>
                                </div>
                            </div>
                        </div>

                        <!-- Result Area -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div id="createMemoryResult"></div>
                            </div>
                        </div>

                        <!-- List Memories -->
                        <div class="row mb-4" id="memoryListSection" style="display: none;">
                            <div class="col-12">
                                <h6><i class="fas fa-list me-2"></i>ç°æœ‰ Memory èµ„æº</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Memory ID</th>
                                                <th>åç§°</th>
                                                <th>çŠ¶æ€</th>
                                                <th>ç±»å‹</th>
                                                <th>åˆ›å»ºæ—¶é—´</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="memoryListBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Initialize Memory -->
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-check-circle me-2"></i>åˆå§‹åŒ– Memory Managers</h6>
                                <p class="text-muted small">
                                    è¾“å…¥æˆ–é€‰æ‹© Memory IDï¼Œç„¶åç‚¹å‡»åˆå§‹åŒ–æŒ‰é’®å¼€å§‹æ¼”ç¤ºã€‚
                                </p>
                            </div>
                            <div class="col-md-5">
                                <label for="stmMemoryId" class="form-label">STM Memory ID</label>
                                <input type="text" class="form-control" id="stmMemoryId" placeholder="mem-xxxxx...">
                            </div>
                            <div class="col-md-5">
                                <label for="ltmMemoryId" class="form-label">LTM Memory ID</label>
                                <input type="text" class="form-control" id="ltmMemoryId" placeholder="mem-xxxxx...">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="initializeMemory()">
                                    <i class="fas fa-play me-2"></i>åˆå§‹åŒ–
                                    <span class="spinner-border spinner-border-sm ms-2 loading" id="initLoading"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Initialize Code Display -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="fas fa-code me-2"></i>åˆå§‹åŒ–ä»£ç </h6>
                                <div class="code-snippet" style="max-height: 300px; overflow-y: auto;">
                                    <pre style="margin: 0;">from bedrock_agentcore.memory.session import MemorySessionManager

# åˆå§‹åŒ– STM Manager
print("ğŸ”„ åˆå§‹åŒ– STM Manager...")
stm_manager = MemorySessionManager(
    memory_id="your-stm-memory-id",
    region_name="us-west-2"
)
print("âœ… STM Manager åˆå§‹åŒ–æˆåŠŸ")

# åˆå§‹åŒ– LTM Manager
print("ğŸ”„ åˆå§‹åŒ– LTM Manager...")
ltm_manager = MemorySessionManager(
    memory_id="your-ltm-memory-id",
    region_name="us-west-2"
)
print("âœ… LTM Manager åˆå§‹åŒ–æˆåŠŸ")

print("\nâœ¨ Memory Managers åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ¼”ç¤ºäº†ï¼")</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Initialize Log Output -->
                        <div class="row mt-3" id="initLogArea" style="display: none;">
                            <div class="col-12">
                                <h6><i class="fas fa-terminal me-2"></i>åˆå§‹åŒ–æ—¥å¿—</h6>
                                <div class="code-snippet" style="max-height: 200px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4;">
                                    <pre id="initLogContent" style="margin: 0; color: #d4d4d4;"></pre>
                                </div>
                            </div>
                        </div>

                        <div id="initResult"></div>
                    </div>

                    <!-- Demo Tabs -->
                    <ul class="nav nav-tabs mt-5" id="memoryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stm-tab" data-bs-toggle="tab" data-bs-target="#stm" type="button" role="tab">
                                <i class="fas fa-clock me-2"></i>Demo 1: Short-term Memory
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ltm-tab" data-bs-toggle="tab" data-bs-target="#ltm" type="button" role="tab">
                                <i class="fas fa-database me-2"></i>Demo 2: Long-term Memory
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="combined-tab" data-bs-toggle="tab" data-bs-target="#combined" type="button" role="tab">
                                <i class="fas fa-layer-group me-2"></i>Demo 3: STM + LTM ç»“åˆ
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="memoryTabContent">
                        <!-- STM Demo -->
                        <div class="tab-pane fade show active" id="stm" role="tabpanel">
                            <div class="demo-section">
                                <h5 class="text-primary">æ¼”ç¤ºè¯´æ˜</h5>
                                <p>STM å­˜å‚¨åŸå§‹å¯¹è¯è½®æ¬¡ï¼Œåªåœ¨å½“å‰ä¼šè¯å†…æœ‰æ•ˆã€‚ç‰¹ç‚¹ï¼šå³æ—¶å­˜å‚¨ã€æ— éœ€ç­‰å¾…ã€ä½†ä¸è·¨ä¼šè¯ã€‚</p>

                                <!-- STM Visual Explanation -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <i class="fas fa-project-diagram me-2"></i>Short-term Memory å·¥ä½œæµ
                                            </div>
                                            <div class="card-body p-2">
                                                <img src="/static/images/memory/short-term-memory-workflow.png"
                                                     class="img-fluid"
                                                     alt="STM Workflow"
                                                     style="width: 100%; height: auto;">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <i class="fas fa-plug me-2"></i>STM Hook é›†æˆæ–¹å¼
                                            </div>
                                            <div class="card-body p-2">
                                                <img src="/static/images/memory/short-term-memory-hook.png"
                                                     class="img-fluid"
                                                     alt="STM Hook"
                                                     style="width: 100%; height: auto;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="mt-4">æ­¥éª¤ 1: ä»‹ç»è‡ªå·±</h6>
                                <p class="text-muted small">åœ¨ä¸‹æ–¹è¾“å…¥ä½ çš„ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»æ‰§è¡Œã€‚STM ä¼šå­˜å‚¨è¿™æ¬¡å¯¹è¯ã€‚</p>

                                <h6 class="mt-3"><i class="fas fa-code me-2"></i>æ­¥éª¤ 1 ä»£ç ç¤ºä¾‹:</h6>
                                <div class="code-snippet">
<pre>from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ stm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

# ========== æ­¥éª¤ 1: å­˜å‚¨ç¬¬ä¸€æ¡å¯¹è¯ ==========
user_message = "æˆ‘å«å¼ ä¸‰ï¼Œæ˜¯ä¸€åè½¯ä»¶å·¥ç¨‹å¸ˆ"
session_id = "session-123"
actor_id = "user-001"

# è°ƒç”¨ LLM ç”Ÿæˆå›å¤
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_message}]}]
)
assistant_response = response['output']['message']['content'][0]['text']

# å­˜å‚¨å¯¹è¯åˆ° STM
stm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id,
    messages=[
        ConversationalMessage(user_message, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print(f"å·²å­˜å‚¨å¯¹è¯åˆ° STMï¼ŒSession ID: {session_id}")</pre>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <label class="form-label">è¾“å…¥ä½ çš„ä¿¡æ¯</label>
                                        <textarea class="form-control" id="stmUserInput1" rows="3" placeholder="ä¾‹å¦‚: æˆ‘å«å¼ ä¸‰ï¼Œæ˜¯ä¸€åè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œå–œæ¬¢ç”¨ Python..."></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Actor ID</label>
                                        <input type="text" class="form-control" id="stmActorId" value="demo-user">
                                    </div>
                                </div>
                                <button class="btn btn-success mt-3" onclick="runSTMStep1()">
                                    <i class="fas fa-play me-2"></i>æ‰§è¡Œæ­¥éª¤ 1
                                    <span class="spinner-border spinner-border-sm ms-2 loading" id="stm1Loading"></span>
                                </button>

                                <!-- Step 1 Code Display -->
                                <div class="row mt-3" id="stmStep1CodeArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-code me-2"></i>æ­¥éª¤ 1 ä»£ç </h6>
                                        <div class="code-snippet" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="stmStep1Code" style="margin: 0;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 1 Log Display -->
                                <div class="row mt-3" id="stmStep1LogArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-terminal me-2"></i>æ­¥éª¤ 1 æ‰§è¡Œæ—¥å¿—</h6>
                                        <div class="code-snippet" id="stmStep1LogDisplay" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4;">
                                            <pre id="stmStep1LogContent" style="margin: 0; color: #d4d4d4;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <div id="stmResult1"></div>

                                <hr class="my-4">

                                <h6>æ­¥éª¤ 2: è¯¢é—®ä¹‹å‰çš„ä¿¡æ¯</h6>
                                <p class="text-muted small">è¯¢é—®ä¸æ­¥éª¤ 1 ç›¸å…³çš„é—®é¢˜ï¼Œæµ‹è¯• STM çš„è®°å¿†èƒ½åŠ›ã€‚</p>

                                <h6 class="mt-3"><i class="fas fa-code me-2"></i>æ­¥éª¤ 2 ä»£ç ç¤ºä¾‹:</h6>
                                <div class="code-snippet">
<pre>from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ stm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ
# session_id å’Œ actor_id æ¥è‡ªæ­¥éª¤ 1

# ========== æ­¥éª¤ 2: åŸºäºå†å²å¯¹è¯å›ç­” ==========
follow_up_question = "ä½ è¿˜è®°å¾—æˆ‘çš„èŒä¸šæ˜¯ä»€ä¹ˆå—?"

# æ£€ç´¢æœ€è¿‘çš„å¯¹è¯å†å²
recent_turns = stm_manager.get_last_k_turns(
    actor_id=actor_id,
    session_id=session_id,
    k=5  # æœ€è¿‘ 5 è½®å¯¹è¯
)

# æ„å»ºä¸Šä¸‹æ–‡
context = ""
for turn in recent_turns:
    for msg in turn:
        role = "ç”¨æˆ·" if msg.get('role') == MessageRole.USER.value else "åŠ©æ‰‹"
        text = msg.get('content', {}).get('text', '')
        context += f"{role}: {text}\n"

# è°ƒç”¨ LLM (å¸¦å†å²ä¸Šä¸‹æ–‡)
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": follow_up_question}]}],
    system=[{"text": f"å†å²å¯¹è¯:\n{context}"}]
)
assistant_response = response['output']['message']['content'][0]['text']

# å­˜å‚¨æ–°çš„å¯¹è¯
stm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id,
    messages=[
        ConversationalMessage(follow_up_question, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print(f"åŠ©æ‰‹å›ç­”: {assistant_response}")</pre>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">è¾“å…¥é—®é¢˜</label>
                                        <textarea class="form-control" id="stmUserInput2" rows="2" placeholder="ä¾‹å¦‚: ä½ è¿˜è®°å¾—æˆ‘çš„èŒä¸šæ˜¯ä»€ä¹ˆå—?"></textarea>
                                    </div>
                                </div>
                                <button class="btn btn-success mt-3" onclick="runSTMStep2()">
                                    <i class="fas fa-play me-2"></i>æ‰§è¡Œæ­¥éª¤ 2
                                    <span class="spinner-border spinner-border-sm ms-2 loading" id="stm2Loading"></span>
                                </button>

                                <!-- Step 2 Code Display -->
                                <div class="row mt-3" id="stmStep2CodeArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-code me-2"></i>æ­¥éª¤ 2 ä»£ç </h6>
                                        <div class="code-snippet" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="stmStep2Code" style="margin: 0;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2 Log Display -->
                                <div class="row mt-3" id="stmStep2LogArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-terminal me-2"></i>æ­¥éª¤ 2 æ‰§è¡Œæ—¥å¿—</h6>
                                        <div class="code-snippet" id="stmStep2LogDisplay" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4;">
                                            <pre id="stmStep2LogContent" style="margin: 0; color: #d4d4d4;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <div id="stmResult2"></div>
                            </div>
                        </div>

                        <!-- LTM Demo -->
                        <div class="tab-pane fade" id="ltm" role="tabpanel">
                            <div class="demo-section">
                                <h5 class="text-primary">æ¼”ç¤ºè¯´æ˜</h5>
                                <p>LTM è‡ªåŠ¨æå–ç”¨æˆ·åå¥½å’Œé‡è¦ä¿¡æ¯ï¼Œå¯è·¨ä¼šè¯ä½¿ç”¨ã€‚ç‰¹ç‚¹ï¼šè¯­ä¹‰æå–ã€è·¨ä¼šè¯ã€æ™ºèƒ½å¬å›ã€‚</p>

                                <!-- LTM Visual Explanation -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <i class="fas fa-plug me-2"></i>Long-term Memory Hook é›†æˆæ–¹å¼
                                            </div>
                                            <div class="card-body p-2 text-center">
                                                <img src="/static/images/memory/long-term-memory-hook.png"
                                                     class="img-fluid"
                                                     alt="LTM Hook"
                                                     style="max-width: 100%; height: auto;">
                                            </div>
                                            <div class="card-footer">
                                                <small class="text-muted">
                                                    <i class="fas fa-lightbulb me-2"></i>
                                                    LTM é€šè¿‡ç­–ç•¥é…ç½®è‡ªåŠ¨æå–è¯­ä¹‰ä¿¡æ¯å’Œç”¨æˆ·åå¥½ï¼Œå®ç°è·¨ä¼šè¯çš„é•¿æœŸè®°å¿†èƒ½åŠ›
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="mt-4">æ­¥éª¤ 1: è¡¨è¾¾ä½ çš„åå¥½</h6>
                                <p class="text-muted small">åœ¨ä¸‹æ–¹è¾“å…¥ä½ çš„åå¥½ä¿¡æ¯ï¼ŒLTM ä¼šè‡ªåŠ¨æå–å¹¶å­˜å‚¨ã€‚</p>

                                <h6 class="mt-3"><i class="fas fa-code me-2"></i>æ­¥éª¤ 1 ä»£ç ç¤ºä¾‹:</h6>
                                <div class="code-snippet">
<pre>from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole
import time

# å‡è®¾ ltm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

# ========== æ­¥éª¤ 1: è¡¨è¾¾åå¥½ (Session 1) ==========
user_preference = "æˆ‘å–œæ¬¢ç®€æ´çš„ä»£ç é£æ ¼ï¼Œæ›´å–œæ¬¢ç”¨ TypeScript"
session_id_1 = "ltm-session-1"
actor_id = "user-001"

# è°ƒç”¨ LLM
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_preference}]}]
)
assistant_response = response['output']['message']['content'][0]['text']

# å­˜å‚¨åˆ° LTM
ltm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id_1,
    messages=[
        ConversationalMessage(user_preference, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print("å·²å­˜å‚¨åå¥½åˆ° LTM")
print("â³ LTM æ­£åœ¨å¼‚æ­¥æå–åå¥½ä¿¡æ¯ï¼Œéœ€è¦ 10-15 ç§’...")

# ç­‰å¾… LTM å¼‚æ­¥æå– (10-15ç§’)
time.sleep(15)</pre>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <label class="form-label">è¾“å…¥ä½ çš„åå¥½</label>
                                        <textarea class="form-control" id="ltmUserInput1" rows="3" placeholder="ä¾‹å¦‚: æˆ‘å–œæ¬¢ç®€æ´çš„ä»£ç é£æ ¼ï¼Œæ›´å–œæ¬¢ç”¨ TypeScript..."></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Actor ID</label>
                                        <input type="text" class="form-control" id="ltmActorId" value="demo-user">
                                    </div>
                                </div>
                                <button class="btn btn-success mt-3" onclick="runLTMStep1()">
                                    <i class="fas fa-play me-2"></i>æ‰§è¡Œæ­¥éª¤ 1
                                    <span class="spinner-border spinner-border-sm ms-2 loading" id="ltm1Loading"></span>
                                </button>

                                <!-- Step 1 Code Display -->
                                <div class="row mt-3" id="ltmStep1CodeArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-code me-2"></i>æ­¥éª¤ 1 ä»£ç </h6>
                                        <div class="code-snippet" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="ltmStep1Code" style="margin: 0;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 1 Log Display -->
                                <div class="row mt-3" id="ltmStep1LogArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-terminal me-2"></i>æ­¥éª¤ 1 æ‰§è¡Œæ—¥å¿—</h6>
                                        <div class="code-snippet" id="ltmStep1LogDisplay" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4;">
                                            <pre id="ltmStep1LogContent" style="margin: 0; color: #d4d4d4;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <div id="ltmResult1"></div>

                                <hr class="my-4">

                                <h6>æ­¥éª¤ 2: æ–°ä¼šè¯ä¸­è¯¢é—® <span class="badge bg-warning text-dark">è¯·å…ˆç­‰å¾… 15 ç§’</span></h6>
                                <p class="text-muted small">
                                    <i class="fas fa-clock me-2"></i>é‡è¦: è¯·ç­‰å¾…çº¦ 15 ç§’åå†æ‰§è¡Œæ­¤æ­¥éª¤ï¼Œä»¥ä¾¿ LTM å®Œæˆå¼‚æ­¥å¤„ç†ã€‚
                                </p>

                                <h6 class="mt-3"><i class="fas fa-code me-2"></i>æ­¥éª¤ 2 ä»£ç ç¤ºä¾‹:</h6>
                                <div class="code-snippet">
<pre>from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ ltm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ
# actor_id æ¥è‡ªæ­¥éª¤ 1

# ========== æ­¥éª¤ 2: æ–°ä¼šè¯ä¸­æ£€ç´¢è®°å¿† (Session 2) ==========
user_question = "èƒ½ç»™æˆ‘ä¸€äº›ç¼–ç¨‹å»ºè®®å—?"
session_id_2 = "ltm-session-2"  # æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæ–°çš„ä¼šè¯ ID

# ä» LTM æ£€ç´¢ç›¸å…³è®°å¿†
memories = ltm_manager.search_long_term_memories(
    query=user_question,
    namespace_prefix="/",
    top_k=3
)

# æ„å»ºä¸Šä¸‹æ–‡
context = ""
for memory in memories:
    content = memory.get('content', {})
    text = content.get('text', '') if isinstance(content, dict) else str(content)
    context += f"- {text}\n"

print(f"ä» LTM æ£€ç´¢åˆ° {len(memories)} æ¡ç›¸å…³è®°å¿†")

# è°ƒç”¨ LLM (å¸¦é•¿æœŸè®°å¿†ä¸Šä¸‹æ–‡)
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_question}]}],
    system=[{"text": f"ç”¨æˆ·çš„é•¿æœŸè®°å¿†:\n{context}"}]
)
assistant_response = response['output']['message']['content'][0]['text']

# å­˜å‚¨æ–°çš„å¯¹è¯
ltm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id_2,
    messages=[
        ConversationalMessage(user_question, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print(f"åŠ©æ‰‹å›ç­”: {assistant_response}")</pre>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">è¾“å…¥é—®é¢˜</label>
                                        <textarea class="form-control" id="ltmUserInput2" rows="2" placeholder="ä¾‹å¦‚: èƒ½ç»™æˆ‘ä¸€äº›ç¼–ç¨‹å»ºè®®å—?"></textarea>
                                    </div>
                                </div>
                                <button class="btn btn-success mt-3" onclick="runLTMStep2()">
                                    <i class="fas fa-play me-2"></i>æ‰§è¡Œæ­¥éª¤ 2
                                    <span class="spinner-border spinner-border-sm ms-2 loading" id="ltm2Loading"></span>
                                </button>

                                <!-- Step 2 Code Display -->
                                <div class="row mt-3" id="ltmStep2CodeArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-code me-2"></i>æ­¥éª¤ 2 ä»£ç </h6>
                                        <div class="code-snippet" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="ltmStep2Code" style="margin: 0;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2 Log Display -->
                                <div class="row mt-3" id="ltmStep2LogArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-terminal me-2"></i>æ­¥éª¤ 2 æ‰§è¡Œæ—¥å¿—</h6>
                                        <div class="code-snippet" id="ltmStep2LogDisplay" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4;">
                                            <pre id="ltmStep2LogContent" style="margin: 0; color: #d4d4d4;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <div id="ltmResult2"></div>
                            </div>
                        </div>

                        <!-- Combined Demo -->
                        <div class="tab-pane fade" id="combined" role="tabpanel">
                            <div class="demo-section">
                                <h5 class="text-primary">æ¼”ç¤ºè¯´æ˜</h5>
                                <p>ç»“åˆä¸¤è€…ä¼˜åŠ¿: STM æä¾›ä¼šè¯è¿è´¯æ€§ + LTM æä¾›é•¿æœŸè®°å¿†ã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µã€‚</p>

                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>æœ€ä½³å®è·µï¼š</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>STM</strong> ç”¨äºç»´æŠ¤å½“å‰ä¼šè¯çš„ä¸Šä¸‹æ–‡ï¼Œä¿æŒå¯¹è¯è¿è´¯æ€§</li>
                                        <li><strong>LTM</strong> ç”¨äºå­˜å‚¨ç”¨æˆ·åå¥½å’Œé‡è¦ä¿¡æ¯ï¼Œå®ç°ä¸ªæ€§åŒ–</li>
                                        <li>ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œæ—¢ä¿è¯å®æ—¶æ€§ï¼Œåˆå®ç°é•¿æœŸè®°å¿†</li>
                                        <li>é€‚åˆæ„å»ºå…·æœ‰è®°å¿†èƒ½åŠ›çš„æ™ºèƒ½åŠ©æ‰‹å’Œå¯¹è¯ç³»ç»Ÿ</li>
                                    </ul>
                                </div>

                                <div class="text-center mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-images me-2"></i>
                                        æƒ³è¦äº†è§£æ›´å¤šæ¶æ„ç»†èŠ‚ï¼Ÿè¯·æŸ¥çœ‹
                                        <a href="#" onclick="document.getElementById('stm-tab').click(); return false;">STM Demo</a> å’Œ
                                        <a href="#" onclick="document.getElementById('ltm-tab').click(); return false;">LTM Demo</a>
                                        æ ‡ç­¾é¡µä¸­çš„æ¶æ„å›¾
                                    </small>
                                </div>

                                <h6 class="mt-3">å®Œæ•´ä»£ç ç¤ºä¾‹:</h6>
                                <div class="code-snippet">
<pre id="combinedCodeSnippet">from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ stm_manager, ltm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

user_question = "æ ¹æ®æˆ‘çš„åå¥½ï¼Œèƒ½ç»™æˆ‘ä¸€äº›å»ºè®®å—?"
actor_id = "demo-user"
session_id = "combined-session"

# 1. ä» LTM è·å–é•¿æœŸè®°å¿†
ltm_memories = ltm_manager.search_long_term_memories(
    query=user_question,
    namespace_prefix="/",
    top_k=3
)

# 2. ä» STM è·å–ä¼šè¯å†å²
try:
    stm_turns = stm_manager.get_last_k_turns(
        actor_id=actor_id,
        session_id=session_id,
        k=3
    )
except:
    stm_turns = []

# 3. æ„å»ºç»¼åˆä¸Šä¸‹æ–‡
context = ""
if ltm_memories:
    context += "é•¿æœŸè®°å¿† (è·¨ä¼šè¯):\n"
    for memory in ltm_memories:
        content = memory.get('content', {})
        text = content.get('text', '')
        context += f"- {text}\n"

if stm_turns:
    context += "\nä¼šè¯å†å² (å½“å‰ä¼šè¯):\n"
    for turn in stm_turns:
        for msg in turn:
            role = "ç”¨æˆ·" if msg.get('role') == MessageRole.USER.value else "åŠ©æ‰‹"
            text = msg.get('content', {}).get('text', '')
            context += f"{role}: {text}\n"

# 4. è°ƒç”¨ LLM (ç»¼åˆ STM + LTM ä¸Šä¸‹æ–‡)
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_question}]}],
    system=[{"text": context}]
)
assistant_response = response['output']['message']['content'][0]['text']

# 5. åŒæ—¶å­˜å‚¨åˆ° STM å’Œ LTM
messages = [
    ConversationalMessage(user_question, MessageRole.USER),
    ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
]
stm_manager.add_turns(actor_id=actor_id, session_id=session_id, messages=messages)
ltm_manager.add_turns(actor_id=actor_id, session_id=session_id, messages=messages)</pre>
                                </div>

                                <h6 class="mt-4">ç»¼åˆæ¼”ç¤º</h6>
                                <div class="row">
                                    <div class="col-md-8">
                                        <label class="form-label">è¾“å…¥é—®é¢˜</label>
                                        <textarea class="form-control" id="combinedUserInput" rows="3" placeholder="ä¾‹å¦‚: æ ¹æ®æˆ‘çš„åå¥½ï¼Œèƒ½ç»™æˆ‘ä¸€äº›å»ºè®®å—?"></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Actor ID</label>
                                        <input type="text" class="form-control" id="combinedActorId" value="demo-user">
                                    </div>
                                </div>
                                <button class="btn btn-success mt-3" onclick="runCombinedDemo()">
                                    <i class="fas fa-play me-2"></i>æ‰§è¡Œç»¼åˆæ¼”ç¤º
                                    <span class="spinner-border spinner-border-sm ms-2 loading" id="combinedLoading"></span>
                                </button>

                                <!-- Combined Demo Code Display -->
                                <div class="row mt-3" id="combinedCodeArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-code me-2"></i>æ‰§è¡Œä»£ç </h6>
                                        <div class="code-snippet" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="combinedCode" style="margin: 0;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <!-- Combined Demo Log Display -->
                                <div class="row mt-3" id="combinedLogArea" style="display: none;">
                                    <div class="col-12">
                                        <h6><i class="fas fa-terminal me-2"></i>æ‰§è¡Œæ—¥å¿—</h6>
                                        <div class="code-snippet" id="combinedLogDisplay" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4;">
                                            <pre id="combinedLogContent" style="margin: 0; color: #d4d4d4;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <div id="combinedResult"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="demo-section mt-4">
                        <h5 class="text-primary">STM vs LTM å¯¹æ¯”è¡¨</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>ç‰¹æ€§</th>
                                        <th>Short-term Memory (STM)</th>
                                        <th>Long-term Memory (LTM)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>å­˜å‚¨å†…å®¹</strong></td>
                                        <td>åŸå§‹å¯¹è¯è½®æ¬¡</td>
                                        <td>æå–çš„åå¥½å’Œè¯­ä¹‰ä¿¡æ¯</td>
                                    </tr>
                                    <tr>
                                        <td><strong>å¤„ç†æ—¶é—´</strong></td>
                                        <td>å³æ—¶ (&lt;1ç§’)</td>
                                        <td>å¼‚æ­¥ (5-15ç§’)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>è®°å¿†èŒƒå›´</strong></td>
                                        <td>å½“å‰ä¼šè¯å†…</td>
                                        <td>è·¨ä¼šè¯ã€æŒä¹…åŒ–</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ä¿¡æ¯å®Œæ•´æ€§</strong></td>
                                        <td>å®Œæ•´ä¿ç•™</td>
                                        <td>æå–æ‘˜è¦</td>
                                    </tr>
                                    <tr>
                                        <td><strong>æ£€ç´¢æ–¹å¼</strong></td>
                                        <td>æŒ‰æ—¶é—´é¡ºåº</td>
                                        <td>è¯­ä¹‰ç›¸å…³æ€§</td>
                                    </tr>
                                    <tr>
                                        <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                                        <td>å¯¹è¯è¿è´¯æ€§ã€ä¸Šä¸‹æ–‡ç»´æŠ¤</td>
                                        <td>ç”¨æˆ·ç”»åƒã€åå¥½è®°å¿†</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script.js"></script>
    <script>
        // State management
        let stmSessionId = '';
        let stmActorId = '';
        let ltmActorId = '';

        // Create STM Memory
        async function createSTMMemory() {
            showLoading('createSTMLoading', true);

            // Show progress message
            showResult('createMemoryResult', 'â³ æ­£åœ¨åˆ›å»º STM Memoryï¼Œè¯·ç¨å€™...', 'success');

            // Clear and prepare displays
            document.getElementById('codeDisplayArea').style.display = 'none';
            document.getElementById('logOutputArea').style.display = 'block';
            document.getElementById('logContent').textContent = '';

            try {
                // Use EventSource for SSE
                const eventSource = new EventSource('/api/memory/create-stm-stream');
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    // Display code
                    const code = event.data;
                    document.getElementById('codeContent').textContent = code;
                    document.getElementById('codeDisplayArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    // Append log line
                    const logContent = document.getElementById('logContent');
                    const logDisplay = document.getElementById('logDisplay');
                    logContent.textContent += event.data + '\n';
                    // Auto-scroll to bottom
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    // Final result
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        // Auto-fill Memory ID
                        document.getElementById('stmMemoryId').value = finalResult.memory_id;
                        showResult('createMemoryResult', `âœ… ${finalResult.message}\n\nMemory ID å·²è‡ªåŠ¨å¡«å……åˆ°ä¸‹æ–¹è¾“å…¥æ¡†`, 'success');
                    } else {
                        showResult('createMemoryResult', 'âŒ ' + finalResult.message, 'error');
                    }

                    // Close connection
                    eventSource.close();
                    showLoading('createSTMLoading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('createMemoryResult', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('createSTMLoading', false);
                };

            } catch (error) {
                showResult('createMemoryResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('createSTMLoading', false);
            }
        }

        // Create LTM Memory
        async function createLTMMemory() {
            showLoading('createLTMLoading', true);

            // Show progress message
            showResult('createMemoryResult', 'â³ æ­£åœ¨åˆ›å»º LTM Memoryï¼ˆé…ç½®ç­–ç•¥ä¸­ï¼‰ï¼Œè¯·ç¨å€™...', 'success');

            // Clear and prepare displays
            document.getElementById('codeDisplayArea').style.display = 'none';
            document.getElementById('logOutputArea').style.display = 'block';
            document.getElementById('logContent').textContent = '';

            try {
                // Use EventSource for SSE
                const eventSource = new EventSource('/api/memory/create-ltm-stream');
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    // Display code
                    const code = event.data;
                    document.getElementById('codeContent').textContent = code;
                    document.getElementById('codeDisplayArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    // Append log line
                    const logContent = document.getElementById('logContent');
                    const logDisplay = document.getElementById('logDisplay');
                    logContent.textContent += event.data + '\n';
                    // Auto-scroll to bottom
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    // Final result
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        // Auto-fill Memory ID
                        document.getElementById('ltmMemoryId').value = finalResult.memory_id;

                        let strategiesText = '';
                        if (finalResult.strategies && finalResult.strategies.length > 0) {
                            strategiesText = '\n\né…ç½®çš„ç­–ç•¥:\n';
                            finalResult.strategies.forEach(s => {
                                strategiesText += `- ${s.name} (${s.type})\n`;
                            });
                        }

                        showResult('createMemoryResult', `âœ… ${finalResult.message}\n\nMemory ID å·²è‡ªåŠ¨å¡«å……åˆ°ä¸‹æ–¹è¾“å…¥æ¡†${strategiesText}`, 'success');
                    } else {
                        showResult('createMemoryResult', 'âŒ ' + finalResult.message, 'error');
                    }

                    // Close connection
                    eventSource.close();
                    showLoading('createLTMLoading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('createMemoryResult', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('createLTMLoading', false);
                };

            } catch (error) {
                showResult('createMemoryResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('createLTMLoading', false);
            }
        }

        // Display logs with animation (like terminal output)
        function displayLogsWithAnimation(logs, callback) {
            const logElement = document.getElementById('logContent');
            const logArea = document.getElementById('logOutputArea');

            logElement.textContent = '';
            logArea.style.display = 'block';

            let index = 0;
            const intervalId = setInterval(() => {
                if (index < logs.length) {
                    logElement.textContent += logs[index] + '\n';
                    // Auto-scroll to bottom
                    const logDisplay = document.getElementById('logDisplay');
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                    index++;
                } else {
                    clearInterval(intervalId);
                    if (callback) callback();
                }
            }, 100); // Display each log line every 100ms
        }

        // List Memories
        async function listMemories() {
            showLoading('listMemoriesLoading', true);

            try {
                const response = await fetch('/api/memory/list');
                const result = await response.json();

                if (result.success && result.memories.length > 0) {
                    const tbody = document.getElementById('memoryListBody');
                    tbody.innerHTML = '';

                    result.memories.forEach(memory => {
                        const row = tbody.insertRow();
                        const memoryType = memory.has_strategies ? 'LTM' : 'STM';
                        const typeClass = memory.has_strategies ? 'badge bg-info' : 'badge bg-success';

                        row.innerHTML = `
                            <td><small>${memory.memory_id}</small></td>
                            <td>${memory.name}</td>
                            <td><span class="badge bg-success">${memory.status}</span></td>
                            <td><span class="${typeClass}">${memoryType}</span></td>
                            <td><small>${new Date(memory.created_at).toLocaleString()}</small></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="selectMemory('${memory.memory_id}', ${memory.has_strategies})">
                                    <i class="fas fa-check"></i> é€‰æ‹©
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewMemoryRecords('${memory.memory_id}', ${memory.has_strategies})">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹
                                </button>
                            </td>
                        `;
                    });

                    document.getElementById('memoryListSection').style.display = 'block';
                    showResult('createMemoryResult', `âœ… ${result.message}`, 'success');
                } else if (result.success && result.memories.length === 0) {
                    showResult('createMemoryResult', 'æœªæ‰¾åˆ°ä»»ä½• Memory èµ„æºï¼Œè¯·å…ˆåˆ›å»ºã€‚', 'error');
                } else {
                    showResult('createMemoryResult', 'âŒ ' + result.message, 'error');
                }
            } catch (error) {
                showResult('createMemoryResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
            } finally {
                showLoading('listMemoriesLoading', false);
            }
        }

        // Select Memory
        function selectMemory(memoryId, hasStrategies) {
            if (hasStrategies) {
                document.getElementById('ltmMemoryId').value = memoryId;
                showResult('createMemoryResult', `âœ… å·²é€‰æ‹© LTM Memory: ${memoryId}`, 'success');
            } else {
                document.getElementById('stmMemoryId').value = memoryId;
                showResult('createMemoryResult', `âœ… å·²é€‰æ‹© STM Memory: ${memoryId}`, 'success');
            }
        }

        // View Memory Records
        async function viewMemoryRecords(memoryId, hasStrategies) {
            const actorId = prompt('è¯·è¾“å…¥ Actor ID (ä¾‹å¦‚: demo-user):', 'demo-user');
            if (!actorId) return;

            if (hasStrategies) {
                // View LTM records
                showResult('createMemoryResult', 'â³ æ­£åœ¨æŸ¥è¯¢ LTM è®°å½•...', 'success');

                try {
                    const response = await fetch('/api/memory/list-ltm-records', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ actor_id: actorId, max_results: 10 })
                    });

                    const result = await response.json();

                    if (result.success && result.records.length > 0) {
                        let recordsText = `âœ… ${result.message}\n\n`;
                        result.records.forEach((record, i) => {
                            recordsText += `${i + 1}. ${record.content_full}\n`;
                            recordsText += `   åˆ›å»ºæ—¶é—´: ${new Date(record.created_at).toLocaleString()}\n\n`;
                        });
                        showResult('createMemoryResult', recordsText, 'success');
                    } else if (result.success && result.records.length === 0) {
                        showResult('createMemoryResult', 'æš‚æ—  LTM è®°å½•ã€‚', 'success');
                    } else {
                        showResult('createMemoryResult', 'âŒ ' + result.message, 'error');
                    }
                } catch (error) {
                    showResult('createMemoryResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
                }
            } else {
                // View STM events
                showResult('createMemoryResult', 'â³ æ­£åœ¨æŸ¥è¯¢ STM äº‹ä»¶...', 'success');

                try {
                    const response = await fetch('/api/memory/list-stm-events', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ actor_id: actorId, max_results: 10 })
                    });

                    const result = await response.json();

                    if (result.success && result.events.length > 0) {
                        let eventsText = `âœ… ${result.message}\n\n`;
                        result.events.forEach((event, i) => {
                            eventsText += `${i + 1}. Session: ${event.session_id}\n`;
                            event.messages.forEach(msg => {
                                eventsText += `   ${msg.role}: ${msg.text}\n`;
                            });
                            eventsText += '\n';
                        });
                        showResult('createMemoryResult', eventsText, 'success');
                    } else if (result.success && result.events.length === 0) {
                        showResult('createMemoryResult', 'æš‚æ—  STM äº‹ä»¶ã€‚', 'success');
                    } else {
                        showResult('createMemoryResult', 'âŒ ' + result.message, 'error');
                    }
                } catch (error) {
                    showResult('createMemoryResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
                }
            }
        }

        // Initialize Memory
        async function initializeMemory() {
            const stmMemoryId = document.getElementById('stmMemoryId').value.trim();
            const ltmMemoryId = document.getElementById('ltmMemoryId').value.trim();

            if (!stmMemoryId || !ltmMemoryId) {
                showResult('initResult', 'è¯·è¾“å…¥ STM å’Œ LTM Memory ID', 'error');
                return;
            }

            showLoading('initLoading', true);

            // Show log area
            document.getElementById('initLogArea').style.display = 'block';
            document.getElementById('initLogContent').textContent = '';

            try {
                // Build URL with query parameters
                const params = new URLSearchParams({
                    stm_memory_id: stmMemoryId,
                    ltm_memory_id: ltmMemoryId
                });

                const eventSource = new EventSource(`/api/memory/initialize-stream?${params}`);
                let finalResult = null;

                eventSource.addEventListener('log', (event) => {
                    const logContent = document.getElementById('initLogContent');
                    const logArea = document.getElementById('initLogArea');
                    logContent.textContent += event.data + '\n';
                    // Auto-scroll to bottom
                    logArea.scrollTop = logArea.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        showResult('initResult', 'âœ… ' + finalResult.message, 'success');
                    } else {
                        showResult('initResult', 'âŒ ' + finalResult.message, 'error');
                    }

                    eventSource.close();
                    showLoading('initLoading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('initResult', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('initLoading', false);
                };

            } catch (error) {
                showResult('initResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('initLoading', false);
            }
        }

        // STM Step 1
        async function runSTMStep1() {
            const userMessage = document.getElementById('stmUserInput1').value.trim();
            const actorId = document.getElementById('stmActorId').value.trim();

            if (!userMessage) {
                showResult('stmResult1', 'è¯·è¾“å…¥ä½ çš„ä¿¡æ¯', 'error');
                return;
            }

            showLoading('stm1Loading', true);

            // Show Step 1 specific log and code areas
            document.getElementById('stmStep1LogArea').style.display = 'block';
            document.getElementById('stmStep1CodeArea').style.display = 'none';
            document.getElementById('stmStep1LogContent').textContent = '';
            document.getElementById('stmStep1Code').textContent = '';

            try {
                // Build URL with query parameters
                const params = new URLSearchParams({
                    user_message: userMessage,
                    actor_id: actorId
                });

                const eventSource = new EventSource(`/api/memory/stm/step1-stream?${params}`);
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    const code = event.data;
                    document.getElementById('stmStep1Code').textContent = code;
                    document.getElementById('stmStep1CodeArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    const logContent = document.getElementById('stmStep1LogContent');
                    const logDisplay = document.getElementById('stmStep1LogDisplay');
                    logContent.textContent += event.data + '\n';
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        stmSessionId = finalResult.session_id;
                        stmActorId = finalResult.actor_id;

                        const output = `âœ… ${finalResult.message}

Session ID: ${finalResult.session_id}

ç”¨æˆ·: ${finalResult.user_message}

åŠ©æ‰‹: ${finalResult.assistant_response}

---
ä¸‹ä¸€æ­¥: è¯·åœ¨æ­¥éª¤ 2 ä¸­è¯¢é—®ç›¸å…³é—®é¢˜ï¼Œæµ‹è¯• STM çš„è®°å¿†èƒ½åŠ›ã€‚`;

                        showResult('stmResult1', output, 'success');
                    } else {
                        showResult('stmResult1', 'âŒ ' + finalResult.message, 'error');
                    }

                    eventSource.close();
                    showLoading('stm1Loading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('stmResult1', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('stm1Loading', false);
                };

            } catch (error) {
                showResult('stmResult1', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('stm1Loading', false);
            }
        }

        // STM Step 2
        async function runSTMStep2() {
            const userMessage = document.getElementById('stmUserInput2').value.trim();

            if (!userMessage) {
                showResult('stmResult2', 'è¯·è¾“å…¥é—®é¢˜', 'error');
                return;
            }

            if (!stmSessionId || !stmActorId) {
                showResult('stmResult2', 'è¯·å…ˆæ‰§è¡Œæ­¥éª¤ 1', 'error');
                return;
            }

            showLoading('stm2Loading', true);

            // Show Step 2 specific log and code areas
            document.getElementById('stmStep2LogArea').style.display = 'block';
            document.getElementById('stmStep2CodeArea').style.display = 'none';
            document.getElementById('stmStep2LogContent').textContent = '';
            document.getElementById('stmStep2Code').textContent = '';

            try {
                // Build URL with query parameters
                const params = new URLSearchParams({
                    user_message: userMessage,
                    session_id: stmSessionId,
                    actor_id: stmActorId
                });

                const eventSource = new EventSource(`/api/memory/stm/step2-stream?${params}`);
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    const code = event.data;
                    document.getElementById('stmStep2Code').textContent = code;
                    document.getElementById('stmStep2CodeArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    const logContent = document.getElementById('stmStep2LogContent');
                    const logDisplay = document.getElementById('stmStep2LogDisplay');
                    logContent.textContent += event.data + '\n';
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        const output = `âœ… ${finalResult.message}

å†å²å¯¹è¯:
${finalResult.context}

å½“å‰é—®é¢˜: ${finalResult.user_message}

åŠ©æ‰‹å›ç­”: ${finalResult.assistant_response}

---
è¯´æ˜: åŠ©æ‰‹èƒ½å¤Ÿè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œä½“ç°äº† STM çš„ä¼šè¯å†…è®°å¿†èƒ½åŠ›ã€‚`;

                        showResult('stmResult2', output, 'success');
                    } else {
                        showResult('stmResult2', 'âŒ ' + finalResult.message, 'error');
                    }

                    eventSource.close();
                    showLoading('stm2Loading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('stmResult2', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('stm2Loading', false);
                };

            } catch (error) {
                showResult('stmResult2', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('stm2Loading', false);
            }
        }

        // LTM Step 1
        async function runLTMStep1() {
            const userPreference = document.getElementById('ltmUserInput1').value.trim();
            const actorId = document.getElementById('ltmActorId').value.trim();

            if (!userPreference) {
                showResult('ltmResult1', 'è¯·è¾“å…¥ä½ çš„åå¥½', 'error');
                return;
            }

            showLoading('ltm1Loading', true);

            // Show Step 1 specific log and code areas
            document.getElementById('ltmStep1LogArea').style.display = 'block';
            document.getElementById('ltmStep1CodeArea').style.display = 'none';
            document.getElementById('ltmStep1LogContent').textContent = '';
            document.getElementById('ltmStep1Code').textContent = '';

            try {
                // Build URL with query parameters
                const params = new URLSearchParams({
                    user_preference: userPreference,
                    actor_id: actorId
                });

                const eventSource = new EventSource(`/api/memory/ltm/step1-stream?${params}`);
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    const code = event.data;
                    document.getElementById('ltmStep1Code').textContent = code;
                    document.getElementById('ltmStep1CodeArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    const logContent = document.getElementById('ltmStep1LogContent');
                    const logDisplay = document.getElementById('ltmStep1LogDisplay');
                    logContent.textContent += event.data + '\n';
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        ltmActorId = finalResult.actor_id;

                        const output = `âœ… ${finalResult.message}

Session ID: ${finalResult.session_id}

ç”¨æˆ·åå¥½: ${finalResult.user_preference}

åŠ©æ‰‹: ${finalResult.assistant_response}

---
â³ LTM æ­£åœ¨å¼‚æ­¥æå–åå¥½ä¿¡æ¯ï¼Œé€šå¸¸éœ€è¦ 10-15 ç§’...

ä¸‹ä¸€æ­¥:
1. ç­‰å¾…çº¦ 15 ç§’
2. ç„¶ååœ¨æ­¥éª¤ 2 ä¸­å¼€å§‹æ–°ä¼šè¯ï¼Œæµ‹è¯•è·¨ä¼šè¯è®°å¿†`;

                        showResult('ltmResult1', output, 'success');
                    } else {
                        showResult('ltmResult1', 'âŒ ' + finalResult.message, 'error');
                    }

                    eventSource.close();
                    showLoading('ltm1Loading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('ltmResult1', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('ltm1Loading', false);
                };

            } catch (error) {
                showResult('ltmResult1', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('ltm1Loading', false);
            }
        }

        // LTM Step 2
        async function runLTMStep2() {
            const userQuestion = document.getElementById('ltmUserInput2').value.trim();

            if (!userQuestion) {
                showResult('ltmResult2', 'è¯·è¾“å…¥é—®é¢˜', 'error');
                return;
            }

            if (!ltmActorId) {
                showResult('ltmResult2', 'è¯·å…ˆæ‰§è¡Œæ­¥éª¤ 1', 'error');
                return;
            }

            showLoading('ltm2Loading', true);

            // Show Step 2 specific log and code areas
            document.getElementById('ltmStep2LogArea').style.display = 'block';
            document.getElementById('ltmStep2CodeArea').style.display = 'none';
            document.getElementById('ltmStep2LogContent').textContent = '';
            document.getElementById('ltmStep2Code').textContent = '';

            try {
                // Build URL with query parameters
                const params = new URLSearchParams({
                    user_question: userQuestion,
                    actor_id: ltmActorId
                });

                const eventSource = new EventSource(`/api/memory/ltm/step2-stream?${params}`);
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    const code = event.data;
                    document.getElementById('ltmStep2Code').textContent = code;
                    document.getElementById('ltmStep2CodeArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    const logContent = document.getElementById('ltmStep2LogContent');
                    const logDisplay = document.getElementById('ltmStep2LogDisplay');
                    logContent.textContent += event.data + '\n';
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        let memoryText = '';
                        if (finalResult.memories && finalResult.memories.length > 0) {
                            memoryText = 'ç”¨æˆ·çš„é•¿æœŸè®°å¿† (æ¥è‡ªä¹‹å‰çš„ä¼šè¯):\n';
                            finalResult.memories.forEach((m, i) => {
                                memoryText += `${i + 1}. ${m.text} (ç›¸å…³æ€§: ${m.relevance.toFixed(2)})\n`;
                            });
                        }

                        const output = `âœ… ${finalResult.message}

æ–° Session ID: ${finalResult.session_id}

${memoryText}

å½“å‰é—®é¢˜: ${finalResult.user_question}

åŠ©æ‰‹å›ç­” (åŸºäºé•¿æœŸè®°å¿†): ${finalResult.assistant_response}

---
è¯´æ˜: å³ä½¿åœ¨æ–°ä¼šè¯ä¸­ï¼ŒåŠ©æ‰‹ä»èƒ½è®°ä½ä¹‹å‰è¡¨è¾¾çš„åå¥½ï¼Œè¿™å°±æ˜¯ LTM çš„è·¨ä¼šè¯è®°å¿†èƒ½åŠ›ã€‚`;

                        showResult('ltmResult2', output, 'success');
                    } else {
                        showResult('ltmResult2', 'âŒ ' + finalResult.message, 'error');
                    }

                    eventSource.close();
                    showLoading('ltm2Loading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('ltmResult2', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('ltm2Loading', false);
                };

            } catch (error) {
                showResult('ltmResult2', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('ltm2Loading', false);
            }
        }

        // Combined Demo
        async function runCombinedDemo() {
            const userQuestion = document.getElementById('combinedUserInput').value.trim();
            const actorId = document.getElementById('combinedActorId').value.trim();

            if (!userQuestion) {
                showResult('combinedResult', 'è¯·è¾“å…¥é—®é¢˜', 'error');
                return;
            }

            showLoading('combinedLoading', true);

            // Show Combined Demo specific log and code areas
            document.getElementById('combinedLogArea').style.display = 'block';
            document.getElementById('combinedCodeArea').style.display = 'none';
            document.getElementById('combinedLogContent').textContent = '';
            document.getElementById('combinedCode').textContent = '';

            try {
                // Build URL with query parameters
                const params = new URLSearchParams({
                    user_question: userQuestion,
                    actor_id: actorId
                });

                const eventSource = new EventSource(`/api/memory/combined-stream?${params}`);
                let finalResult = null;

                eventSource.addEventListener('code', (event) => {
                    const code = event.data;
                    document.getElementById('combinedCode').textContent = code;
                    document.getElementById('combinedCodeArea').style.display = 'block';
                });

                eventSource.addEventListener('log', (event) => {
                    const logContent = document.getElementById('combinedLogContent');
                    const logDisplay = document.getElementById('combinedLogDisplay');
                    logContent.textContent += event.data + '\n';
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                });

                eventSource.addEventListener('result', (event) => {
                    finalResult = JSON.parse(event.data);

                    if (finalResult.success) {
                        let contextText = '';

                        if (finalResult.ltm_memories && finalResult.ltm_memories.length > 0) {
                            contextText += 'é•¿æœŸè®°å¿† (è·¨ä¼šè¯):\n';
                            finalResult.ltm_memories.forEach(m => {
                                contextText += `- ${m}\n`;
                            });
                            contextText += '\n';
                        }

                        if (finalResult.stm_history && finalResult.stm_history.length > 0) {
                            contextText += 'ä¼šè¯å†å² (å½“å‰ä¼šè¯):\n';
                            finalResult.stm_history.forEach(h => {
                                contextText += `${h.role}: ${h.text}\n`;
                            });
                        }

                        if (!contextText) {
                            contextText = 'æš‚æ— å†å²è®°å¿†';
                        }

                        const output = `âœ… ${finalResult.message}

Session ID: ${finalResult.session_id}

${contextText}

å½“å‰é—®é¢˜: ${finalResult.user_question}

åŠ©æ‰‹å›ç­” (ç»¼åˆè®°å¿†): ${finalResult.assistant_response}

---
è¯´æ˜:
- åŠ©æ‰‹åŒæ—¶åˆ©ç”¨äº†çŸ­æœŸä¼šè¯è®°å¿†å’Œé•¿æœŸç”¨æˆ·è®°å¿†
- è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µæ¨¡å¼
- æ—¢ä¿è¯äº†å¯¹è¯è¿è´¯æ€§ï¼Œåˆå®ç°äº†ä¸ªæ€§åŒ–`;

                        showResult('combinedResult', output, 'success');
                    } else {
                        showResult('combinedResult', 'âŒ ' + finalResult.message, 'error');
                    }

                    eventSource.close();
                    showLoading('combinedLoading', false);
                });

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    if (!finalResult) {
                        showResult('combinedResult', 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    }
                    showLoading('combinedLoading', false);
                };

            } catch (error) {
                showResult('combinedResult', 'âŒ é”™è¯¯: ' + error.message, 'error');
                showLoading('combinedLoading', false);
            }
        }

        // Helper functions
        function showResult(elementId, message, type) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.innerHTML = `<div class="result-box ${type}">${message}</div>`;
        }

        function showLoading(elementId, show) {
            const loadingElement = document.getElementById(elementId);
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }

        // Real-time code-input linkage
        // Helper function to escape special characters for code snippets
        function escapeCodeValue(value) {
            return value.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        }

        // STM Demo Step 1 - Update code when user types
        document.getElementById('stmUserInput1').addEventListener('input', function(e) {
            updateSTMStep1Code();
        });
        document.getElementById('stmActorId').addEventListener('input', function(e) {
            updateSTMStep1Code();
        });

        function updateSTMStep1Code() {
            const userMessage = document.getElementById('stmUserInput1').value || 'æˆ‘å«å¼ ä¸‰ï¼Œæ˜¯ä¸€åè½¯ä»¶å·¥ç¨‹å¸ˆ';
            const actorId = document.getElementById('stmActorId').value || 'demo-user';
            const sessionId = stmSessionId || 'stm-session-xxx';

            const codeSnippet = `# STM Demo - æ­¥éª¤ 1: å­˜å‚¨ç¬¬ä¸€æ¡å¯¹è¯
from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ stm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

user_message = "${escapeCodeValue(userMessage)}"
actor_id = "${escapeCodeValue(actorId)}"
session_id = "${sessionId}"

print("ğŸ“ ç”¨æˆ·æ¶ˆæ¯:", user_message)
print("ğŸ‘¤ Actor ID:", actor_id)
print("ğŸ”— Session ID:", session_id)
print()

# è°ƒç”¨ LLM ç”Ÿæˆå›å¤
print("ğŸ¤– è°ƒç”¨ LLM ç”Ÿæˆå›å¤...")
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_message}]}]
)
assistant_response = response['output']['message']['content'][0]['text']
print("âœ… LLM å›å¤:", assistant_response[:50], "...")
print()

# å­˜å‚¨åˆ° STM
print("ğŸ’¾ å­˜å‚¨å¯¹è¯åˆ° STM...")
stm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id,
    messages=[
        ConversationalMessage(user_message, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print("âœ… å·²å­˜å‚¨åˆ° Short-term Memory")
print(f"ğŸ“Š Session ID: {session_id}")`;

            // Find the code snippet in STM tab
            const stmTab = document.getElementById('stm');
            const codeBlock = stmTab.querySelector('.code-snippet pre');
            if (codeBlock) {
                codeBlock.textContent = codeSnippet;
            }
        }

        // STM Demo Step 2 - Update code when user types
        document.getElementById('stmUserInput2').addEventListener('input', function(e) {
            updateSTMStep2Code();
        });

        function updateSTMStep2Code() {
            const userMessage = document.getElementById('stmUserInput2').value || 'ä½ è¿˜è®°å¾—æˆ‘çš„èŒä¸šæ˜¯ä»€ä¹ˆå—?';
            const actorId = document.getElementById('stmActorId').value || 'demo-user';
            const sessionId = stmSessionId || 'stm-session-xxx';

            const codeSnippet = `# STM Demo - æ­¥éª¤ 2: åŸºäºå†å²å¯¹è¯å›ç­”
from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ stm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

user_message = "${escapeCodeValue(userMessage)}"
session_id = "${sessionId}"
actor_id = "${escapeCodeValue(actorId)}"

print("ğŸ“ ç”¨æˆ·é—®é¢˜:", user_message)
print("ğŸ”— Session ID:", session_id)
print()

# è·å–å†å²å¯¹è¯
print("ğŸ” ä» STM æ£€ç´¢å†å²å¯¹è¯...")
recent_turns = stm_manager.get_last_k_turns(
    actor_id=actor_id,
    session_id=session_id,
    k=5
)

# æ„å»ºä¸Šä¸‹æ–‡
context = ""
for turn in recent_turns:
    for msg in turn:
        role = "ç”¨æˆ·" if msg.get('role') == MessageRole.USER.value else "åŠ©æ‰‹"
        text = msg.get('content', {}).get('text', '')
        context += f"{role}: {text}\\n"

print(f"âœ… æ£€ç´¢åˆ° {len(recent_turns)} è½®å†å²å¯¹è¯")
print()

# è°ƒç”¨ LLM (å¸¦å†å²ä¸Šä¸‹æ–‡)
print("ğŸ¤– è°ƒç”¨ LLM ç”Ÿæˆå›å¤ (åŸºäºå†å²ä¸Šä¸‹æ–‡)...")
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_message}]}],
    system=[{"text": f"å†å²å¯¹è¯:\\n{context}"}]
)
assistant_response = response['output']['message']['content'][0]['text']
print("âœ… LLM å›å¤:", assistant_response[:50], "...")
print()

# å­˜å‚¨æ–°çš„å¯¹è¯
print("ğŸ’¾ å­˜å‚¨æ–°å¯¹è¯åˆ° STM...")
stm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id,
    messages=[
        ConversationalMessage(user_message, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print("âœ… å·²å­˜å‚¨ï¼Œå¯¹è¯å†å²å·²æ›´æ–°")`;

            // Update the same code block - it's shared between step 1 and step 2
            const stmTab = document.getElementById('stm');
            const codeBlock = stmTab.querySelector('.code-snippet pre');
            if (codeBlock) {
                codeBlock.textContent = codeSnippet;
            }
        }

        // LTM Demo Step 1 - Update code when user types
        document.getElementById('ltmUserInput1').addEventListener('input', function(e) {
            updateLTMStep1Code();
        });
        document.getElementById('ltmActorId').addEventListener('input', function(e) {
            updateLTMStep1Code();
        });

        function updateLTMStep1Code() {
            const userPreference = document.getElementById('ltmUserInput1').value || 'æˆ‘å–œæ¬¢ç®€æ´çš„ä»£ç é£æ ¼ï¼Œæ›´å–œæ¬¢ç”¨ TypeScript';
            const actorId = document.getElementById('ltmActorId').value || 'demo-user';
            const sessionId = 'ltm-session-1-xxx';

            const codeSnippet = `# LTM Demo - æ­¥éª¤ 1: è¡¨è¾¾åå¥½
from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole
import time

# å‡è®¾ ltm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

user_preference = "${escapeCodeValue(userPreference)}"
actor_id = "${escapeCodeValue(actorId)}"
session_id = "${sessionId}"

print("ğŸ“ ç”¨æˆ·åå¥½:", user_preference)
print("ğŸ‘¤ Actor ID:", actor_id)
print("ğŸ”— Session ID:", session_id)
print()

# è°ƒç”¨ LLM ç”Ÿæˆå›å¤
print("ğŸ¤– è°ƒç”¨ LLM ç”Ÿæˆå›å¤...")
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_preference}]}]
)
assistant_response = response['output']['message']['content'][0]['text']
print("âœ… LLM å›å¤:", assistant_response[:50], "...")
print()

# å­˜å‚¨åˆ° LTM
print("ğŸ’¾ å­˜å‚¨åå¥½åˆ° LTM...")
ltm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id,
    messages=[
        ConversationalMessage(user_preference, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print("âœ… å·²å­˜å‚¨åˆ° Long-term Memory")
print(f"ğŸ“Š Session ID: {session_id}")
print()
print("â³ LTM æ­£åœ¨å¼‚æ­¥æå–åå¥½ä¿¡æ¯ï¼Œé€šå¸¸éœ€è¦ 10-15 ç§’...")`;

            const ltmTab = document.getElementById('ltm');
            const codeBlock = ltmTab.querySelector('.code-snippet pre');
            if (codeBlock) {
                codeBlock.textContent = codeSnippet;
            }
        }

        // LTM Demo Step 2 - Update code when user types
        document.getElementById('ltmUserInput2').addEventListener('input', function(e) {
            updateLTMStep2Code();
        });

        function updateLTMStep2Code() {
            const userQuestion = document.getElementById('ltmUserInput2').value || 'èƒ½ç»™æˆ‘ä¸€äº›ç¼–ç¨‹å»ºè®®å—?';
            const actorId = document.getElementById('ltmActorId').value || 'demo-user';
            const sessionId = 'ltm-session-2-xxx';

            const codeSnippet = `# LTM Demo - æ­¥éª¤ 2: æ–°ä¼šè¯ä¸­æ£€ç´¢è®°å¿†
from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ ltm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

user_question = "${escapeCodeValue(userQuestion)}"
actor_id = "${escapeCodeValue(actorId)}"
session_id = "${sessionId}"

print("ğŸ“ ç”¨æˆ·é—®é¢˜:", user_question)
print("ğŸ”— æ–° Session ID:", session_id)
print()

# ä» LTM æ£€ç´¢ç›¸å…³è®°å¿†
print("ğŸ” ä» LTM æ£€ç´¢ç›¸å…³è®°å¿†...")
memories = ltm_manager.search_long_term_memories(
    query=user_question,
    namespace_prefix="/",
    top_k=5
)

# æ„å»ºä¸Šä¸‹æ–‡
context = ""
for memory in memories:
    content = memory.get('content', {})
    text = content.get('text', '') if isinstance(content, dict) else str(content)
    context += f"- {text}\\n"

print(f"âœ… æ£€ç´¢åˆ° {len(memories)} æ¡ç›¸å…³è®°å¿†")
print()

# æ˜¾ç¤ºè®°å¿†å†…å®¹
if memories:
    print("ğŸ“œ æ£€ç´¢åˆ°çš„é•¿æœŸè®°å¿†:")
    for i, memory in enumerate(memories[:3], 1):
        content = memory.get('content', {})
        text = content.get('text', '')
        relevance = memory.get('relevanceScore', 0.0)
        print(f"  {i}. {text[:60]}... (ç›¸å…³æ€§: {relevance:.2f})")
print()

# è°ƒç”¨ LLM (å¸¦é•¿æœŸè®°å¿†ä¸Šä¸‹æ–‡)
print("ğŸ¤– è°ƒç”¨ LLM ç”Ÿæˆå›å¤ (åŸºäºé•¿æœŸè®°å¿†)...")
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_question}]}],
    system=[{"text": f"ç”¨æˆ·çš„é•¿æœŸè®°å¿†:\\n{context}"}]
)
assistant_response = response['output']['message']['content'][0]['text']
print("âœ… LLM å›å¤:", assistant_response[:50], "...")
print()

# å­˜å‚¨æ–°çš„å¯¹è¯
print("ğŸ’¾ å­˜å‚¨æ–°å¯¹è¯åˆ° LTM...")
ltm_manager.add_turns(
    actor_id=actor_id,
    session_id=session_id,
    messages=[
        ConversationalMessage(user_question, MessageRole.USER),
        ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
    ]
)
print("âœ… å·²å­˜å‚¨ï¼Œè·¨ä¼šè¯è®°å¿†åŠŸèƒ½å±•ç¤ºå®Œæˆ")`;

            const ltmTab = document.getElementById('ltm');
            const codeBlock = ltmTab.querySelector('.code-snippet pre');
            if (codeBlock) {
                codeBlock.textContent = codeSnippet;
            }
        }

        // Combined Demo - Update code when user types
        document.getElementById('combinedUserInput').addEventListener('input', function(e) {
            updateCombinedCode();
        });
        document.getElementById('combinedActorId').addEventListener('input', function(e) {
            updateCombinedCode();
        });

        function updateCombinedCode() {
            const userQuestion = document.getElementById('combinedUserInput').value || 'æ ¹æ®æˆ‘çš„åå¥½ï¼Œèƒ½ç»™æˆ‘ä¸€äº›å»ºè®®å—?';
            const actorId = document.getElementById('combinedActorId').value || 'demo-user';
            const sessionId = 'combined-session-xxx';

            const codeSnippet = `from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole

# å‡è®¾ stm_manager, ltm_manager å’Œ bedrock_runtime å·²åœ¨ä¸Šé¢åˆå§‹åŒ–å®Œæˆ

user_question = "${escapeCodeValue(userQuestion)}"
actor_id = "${escapeCodeValue(actorId)}"
session_id = "${sessionId}"

# 1. ä» LTM è·å–é•¿æœŸè®°å¿†
ltm_memories = ltm_manager.search_long_term_memories(
    query=user_question,
    namespace_prefix="/",
    top_k=3
)

# 2. ä» STM è·å–ä¼šè¯å†å²
try:
    stm_turns = stm_manager.get_last_k_turns(
        actor_id=actor_id,
        session_id=session_id,
        k=3
    )
except:
    stm_turns = []

# 3. æ„å»ºç»¼åˆä¸Šä¸‹æ–‡
context = ""
if ltm_memories:
    context += "é•¿æœŸè®°å¿† (è·¨ä¼šè¯):\\n"
    for memory in ltm_memories:
        content = memory.get('content', {})
        text = content.get('text', '')
        context += f"- {text}\\n"

if stm_turns:
    context += "\\nä¼šè¯å†å² (å½“å‰ä¼šè¯):\\n"
    for turn in stm_turns:
        for msg in turn:
            role = "ç”¨æˆ·" if msg.get('role') == MessageRole.USER.value else "åŠ©æ‰‹"
            text = msg.get('content', {}).get('text', '')
            context += f"{role}: {text}\\n"

# 4. è°ƒç”¨ LLM (ç»¼åˆ STM + LTM ä¸Šä¸‹æ–‡)
response = bedrock_runtime.converse(
    modelId="us.anthropic.claude-sonnet-4-5-20250929-v1:0",
    messages=[{"role": "user", "content": [{"text": user_question}]}],
    system=[{"text": context}]
)
assistant_response = response['output']['message']['content'][0]['text']

# 5. åŒæ—¶å­˜å‚¨åˆ° STM å’Œ LTM
messages = [
    ConversationalMessage(user_question, MessageRole.USER),
    ConversationalMessage(assistant_response, MessageRole.ASSISTANT)
]
stm_manager.add_turns(actor_id=actor_id, session_id=session_id, messages=messages)
ltm_manager.add_turns(actor_id=actor_id, session_id=session_id, messages=messages)`;

            const codeBlock = document.getElementById('combinedCodeSnippet');
            if (codeBlock) {
                codeBlock.textContent = codeSnippet;
            }
        }

    </script>
</body>
</html>
